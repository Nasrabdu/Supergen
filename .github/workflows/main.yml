name: Telegram Watcher (Self-Hosted)

on:
  workflow_dispatch: {}      # تشغيل يدوي من Actions
  schedule:
    - cron: "0 0 * * *"     # إعادة تشغيل يومية اختيارية للثبات (يمكن حذفها)

jobs:
  run:
    # هذا الجوب يعمل على الـ VPS الذي سجّلته كـ Self-Hosted Runner
    runs-on: self-hosted
    # على الـ Self-Hosted يمكنك تشغيل الجوب حتى 5 أيام (نضع 5 أيام تقريبًا)
    timeout-minutes: 7190    # أقل قليلًا من 7200 دقيقة (5 أيام)

    permissions:
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install telethon==1.34.0 requests>=2.31.0
          fi

      - name: Materialize secrets to files
        run: |
          # نكتب الجلسات المرمّزة وقائمة المستقبلين إلى ملفات محلية
          printf '%s' '${{ secrets.SESSIONS_JSON }}' > sessions.json
          printf '%s' '${{ secrets.ALLOWED_IDS_JSON }}' > allowed_ids.json

      - name: Run Telegram watcher
        env:
          TELEGRAM_API_ID:     ${{ secrets.TELEGRAM_API_ID }}
          TELEGRAM_API_HASH:   ${{ secrets.TELEGRAM_API_HASH }}
          TELEGRAM_BOT_TOKEN:  ${{ secrets.TELEGRAM_BOT_TOKEN }}
          SESS_FILE:           "sessions.json"
          ALLOWED_IDS_FILE:    "allowed_ids.json"
          DB_PATH:             "seen.db"
        run: |
          python telegram_watcher.py
