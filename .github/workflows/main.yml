name: Telegram Bot VPS

on:
  workflow_dispatch:
  # Ø§Ø®ØªÙŠØ§Ø±ÙŠ: Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ (ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø­Ø°Ù)
  schedule:
    - cron: "0 */6 * * *"

jobs:
  secure-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360    # Ø£Ù‚ØµÙ‰ Ù…Ø¯Ø© 6 Ø³Ø§Ø¹Ø§Øª ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹

    steps:
      - name: Install & Configure SSH
        run: |
          sudo apt update -y
          sudo apt install -y openssh-server
          sudo systemctl enable ssh
          sudo systemctl start ssh
          echo "root:admin@123" | sudo chpasswd
          echo "PermitRootLogin yes" | sudo tee -a /etc/ssh/sshd_config
          sudo service ssh restart
          echo "âœ… SSH user: root | pass: admin@123"

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=vps-bot
          tsIP=$(tailscale ip -4 | head -n 1)
          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
          echo "âœ… Tailscale IP: $tsIP"

      - name: Checkout bot code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install telethon==1.34.0 requests>=2.31.0
          fi

      - name: Prepare secrets
        run: |
          printf '%s' '${{ secrets.SESSIONS_JSON }}' > sessions.json
          printf '%s' '${{ secrets.ALLOWED_IDS_JSON }}' > allowed_ids.json

      - name: Run Telegram watcher
        env:
          TELEGRAM_API_ID:   ${{ secrets.TELEGRAM_API_ID }}
          TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
          TELEGRAM_BOT_TOKEN:${{ secrets.TELEGRAM_BOT_TOKEN }}
          SESS_FILE:         "sessions.json"
          ALLOWED_IDS_FILE:  "allowed_ids.json"
          DB_PATH:           "seen.db"
        run: |
          echo "ðŸš€ Starting Telegram Bot..."
          python telegram_watcher.py &

      - name: Keep VPS Alive
        run: |
          while true; do
            echo "[ $(date) ] VPS with bot running..."
            sleep 300
          done
